steps:
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/zip', '.']

- name: 'gcr.io/$PROJECT_ID/zip'
  args: ['-r', '/workspace/function.zip', '.']
  dir: 'delete-datasets/src'

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gsutil cp /workspace/function.zip gs://$PROJECT_ID-europe-west2-cloudfunctions/dataset-deletion-function/dataset-deletion-function-source.zip

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args:
  - 'gcloud'
  - 'functions'
  - 'deploy'
  - 'dataset-deletion-function'
  - "--gen2"
  - "--no-allow-unauthenticated"
  - "--ingress-settings"
  - "all"
  - '--runtime'
  - 'python311'
  - '--region'
  - 'europe-west2'
  - '--entry-point'
  - 'delete_dataset'
  - '--timeout'
  - '3600s'
  - '--memory'
  - '10G'
  - '--cpu'
  - '4'
  - '--trigger-http'
  - '--source'
  - 'gs://$PROJECT_ID-europe-west2-cloudfunctions/dataset-deletion-function/dataset-deletion-function-source.zip'

options:
  logging: CLOUD_LOGGING_ONLY
images: ['gcr.io/$PROJECT_ID/zip']